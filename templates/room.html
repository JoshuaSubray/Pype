{% extends 'base.html' %} {% block content %}
<div class="message-box">
    <h2>Chat Room: {{code}}</h2>
    <div class="room-controls">
        <button id="lock-btn" class="lock-btn" onclick="toggleRoomLock()">
            <span id="lock-icon">ðŸ”“</span> <span id="lock-text">Lock Room</span>
        </button>   
    <button onclick="leaveRoom()" class="leave-btn"><i class="bi bi-box-arrow-right"></i>Leave Room</button>
    <div class="messages" id="messages"></div>
    <div class="inputs">
        <input
            type="text"
            rows="3"
            placeholder="Message"
            name="message"
            id="message"
        />
        <button type = "button" name="send" id="send-btn" onClick="sendMessage()">
            Send
        </button>
    </div>
</div>

<div id="password-modal" class="modal">
    <div class="modal-content">
        <h3>Make Room Password</h3>
        <input type="password" id="room-password" placeholder="Enter password">
        <div class="modal-buttons">
            <button onclick="confirmLock()">Confirm</button>
            <button onclick="cancelLock()">Cancel</button>
        </div>
    </div>
</div>

<script type="text/javascript">
    var socketio = io();
    const roomCode = "{{code}}";
    const userName = "{{session.get('name')}}";

    let isCreator = false;

    fetch(`/api/room/${roomCode}`)
        .then(res => res.json())
        .then(roomData => {
            isCreator = roomData.creator === userName;
            updateLockButton(roomData.locked);
            
            // hide lock button if not creator.
            if (!isCreator) {
                document.getElementById('lock-btn').style.display = 'none';
        }
    });

    function updateLockButton(isLocked) {
        const lockIcon = document.getElementById('lock-icon');
        const lockText = document.getElementById('lock-text');
        
        if (isLocked) {
            lockIcon.textContent = 'ðŸ”';
            lockText.textContent = 'Unlock Room';
        } else {
            lockIcon.textContent = 'ðŸ”“';
            lockText.textContent = 'Lock Room';
        }
    }

    function toggleRoomLock() {
        if (!isCreator) return;
        
        // show password modal when locking.
        const modal = document.getElementById('password-modal');
        modal.style.display = 'block';
    }
    
    function confirmLock() {
        const password = document.getElementById('room-password').value;
        const modal = document.getElementById('password-modal');
        
        fetch(`/api/room/${roomCode}/lock`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: userName,
                password: password
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateLockButton(data.locked);
                modal.style.display = 'none';
                document.getElementById('room-password').value = '';
            } else {
                alert(data.error || 'Failed to toggle lock status');
            }
        });
    }

    function cancelLock() {
        document.getElementById('password-modal').style.display = 'none';
        document.getElementById('room-password').value = '';
    }

    const messages = document.getElementById("messages");

    const createMessage = (name, msg) => {
        const content = `
        <div class="text">
            <span>
                <strong>${name}</strong>: ${msg}
            </span>
            <span class="muted">
                ${new Date().toLocaleString()}
            </span>
        </div>
        `;
        messages.innerHTML += content;
    };

    socketio.on("message", (data) => {
        createMessage(data.name, data.message);
    })

    const sendMessage = () => {
        const message = document.getElementById("message")
        if (message.value === "") return;
        socketio.emit("message", {data: message.value})
        message.value = "";
    }

    document.getElementById("message").addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    const leaveRoom = () => {
        socketio.emit("leave_room");
        fetch("/clear_session", { method: "POST" })
          .then(() => {
            window.location.href = "{{ url_for('home') }}";
          });
      };

</script>

<!-- dynamically call createMessage for every message in message history. -->
{% for msg in messages %}
<script type="text/javascript">
    const messagesContainer = document.getElementById("messages");

    // fetch messages from the new endpoint.
    function refreshMessages() {
        fetch(`/api/room/${roomCode}/messages`)
            .then(response => response.json())
            .then(data => {
                // clear current messages to avoid duplicates.
                messagesContainer.innerHTML = '';
                // loop through the messages and add them to the chat.
                data.forEach(msg => {
                    createMessage(msg.name, msg.message);
                });
            })
            .catch(error => console.error('Error fetching messages:', error));
    }

    // refresh messages every 1 second.
    setInterval(refreshMessages, 1000);
</script>
{% endfor %}
{% endblock %}